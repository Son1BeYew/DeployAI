<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N·∫°p ti·ªÅn & Premium | EternaPicSHT AI</title>
    <link rel="icon" type="image/png" href="/assets/images/logo.png" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/header.css" />
    <link rel="stylesheet" href="/assets/css/footer.css" />
    <link rel="stylesheet" href="/assets/css/topup-premium.css" />
    <style>
      .main-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        background: #f5f5f5;
        padding: 6px;
        border-radius: 12px;
        width: fit-content;
      }

      .tab-btn {
        padding: 12px 32px;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        color: #6b6b6b;
        transition: all 0.2s ease;
        border-radius: 8px;
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: #2d2d2d;
      }

      .tab-btn.active {
        background: #ffffff;
        color: #1a1a1a;
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .topup-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .topup-wrapper {
        display: flex;
        flex-direction: column;
      }

      .topup-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .topup-card h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #222;
      }

      .topup-card p {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .history-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
      }

      .form-group input:focus {
        outline: none;
        border-color: #555;
        box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.1);
      }

      .amount-presets {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }

      .amount-btn {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f5f5f5;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 13px;
      }

      .amount-btn:hover {
        background: #e5e5e5;
        border-color: #555;
      }

      .amount-btn.active {
        background: #555;
        color: #fff;
        border-color: #555;
      }

      .payment-method {
        margin: 20px 0;
      }

      .payment-method h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
      }

      .method-options {
        display: flex;
        gap: 10px;
      }

      .method-option {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .method-logo {
        width: 36px;
        height: 36px;
        object-fit: contain;
        border-radius: 8px;
      }

      .method-option:hover {
        border-color: #555;
      }

      .method-option.active {
        border-color: #555;
        background: #f5f5f5;
      }

      .method-option input {
        display: none;
      }

      .topup-btn {
        width: 100%;
        padding: 14px;
        background: #555;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 10px;
      }

      .topup-btn:hover:not(:disabled) {
        background: #333;
      }

      .topup-btn:disabled {
        background: #999;
        cursor: not-allowed;
      }

      .history-section {
        margin: 0;
        padding: 0;
        border: none;
      }

      .history-section h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .history-item {
        padding: 12px;
        background: #f5f5f5;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .history-info {
        flex: 1;
      }

      .history-amount {
        font-weight: 600;
        color: #2ecc71;
      }

      .history-time {
        font-size: 12px;
        color: #999;
      }

      .history-status {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-failed {
        background: #f8d7da;
        color: #721c24;
      }

      .status-cancelled {
        background: #e2e8f0;
        color: #64748b;
      }

      .cancel-btn {
        padding: 4px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .cancel-btn:hover {
        background: #dc2626;
      }

      .view-all-btn {
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: #555;
        transition: all 0.3s;
        font-size: 14px;
      }

      .view-all-btn:hover {
        background: #e5e5e5;
        border-color: #555;
      }

      /* General Modal Styles (for history modals) */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 15px;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .close-btn:hover {
        color: #333;
      }

      .modal-history-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .info-message {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #004085;
      }

      .balance-card {
        background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
        color: #2d2d2d;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e5e5;
      }

      .balance-card h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: #2d2d2d;
      }

      .balance-amount {
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
        color: #1a1a1a;
      }

      .balance-unit {
        font-size: 18px;
        margin-left: 5px;
        color: #4a4a4a;
      }

      /* Premium Styles */
      .premium-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .current-plan-section {
        background: linear-gradient(135deg, white, #666);
        border-radius: 16px;
        padding: 40px;
        color: white;
        margin-bottom: 40px;
        text-align: center;
      }

      .current-plan-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 15px;
      }

      .current-plan-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 20px;
        border-radius: 25px;
        font-weight: 600;
        margin-bottom: 25px;
      }

      .current-plan-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 30px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      .plans-section {
        margin-bottom: 40px;
      }

      .section-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .section-subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
      }

      /* Premium grid and card styles moved to topup-premium.css */

      /* OLD PREMIUM STYLES - REMOVED - Now using topup-premium.css */

      .faq-section {
        max-width: 800px;
        margin: 60px auto 40px;
        padding: 0 20px;
      }

      .faq-section .section-title {
        margin-bottom: 8px;
      }

      .faq-section .section-subtitle {
        margin-bottom: 32px;
      }

      .faq-item {
        background: #ffffff;
        border-radius: 12px;
        padding: 24px 28px;
        margin-bottom: 12px;
        border: 1px solid #e5e5e5;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .faq-item:hover {
        border-color: #d4d4d4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .faq-question {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1a1a1a;
        line-height: 1.5;
      }

      .faq-answer {
        font-size: 14px;
        color: #6b6b6b;
        line-height: 1.7;
      }

      .upgrade-history-section {
        background: white;
        border-radius: 16px;
        padding: 0;
        margin-top: 60px;
        border: 1px solid #e9ecef;
        overflow: hidden;
      }

      .section-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 40px 30px;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
      }

      .history-timeline {
        padding: 40px 30px;
        min-height: 200px;
      }

      .empty-history {
        text-align: center;
        padding: 40px 20px;
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-history h3 {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .empty-history p {
        color: #666;
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 25px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }

      .upgrade-now-btn {
        background: linear-gradient(135deg, #4a90e2, #666);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3 );
      }

      .upgrade-now-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
      }

      .history-item-timeline {
        display: flex;
        align-items: flex-start;
        margin-bottom: 30px;
        position: relative;
      }

      .history-item-timeline::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 40px;
        bottom: -30px;
        width: 2px;
        background: #e9ecef;
      }

      .history-item-timeline:last-child::before {
        display: none;
      }

      .history-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        flex-shrink: 0;
        font-size: 18px;
        z-index: 1;
      }

      .history-icon.success {
        background: #d4edda;
        color: #666;
        border: 2px solid #c3e6cb;
      }

      .history-icon.pending {
        background: #fff3cd;
        color: #ffc107;
        border: 2px solid #ffeaa7;
      }

      .history-icon.failed {
        background: #f8d7da;
        color: #dc3545;
        border: 2px solid #f5c6cb;
      }

      .history-content {
        flex: 1;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }

      .history-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
      }

      .history-plan-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .history-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: auto;
      }

      .history-status.success {
        background: #d4edda;
        color: #155724;
      }

      .history-status.pending {
        background: #fff3cd;
        color: #856404;
      }

      .history-status.failed {
        background: #f8d7da;
        color: #721c24;
      }

      .history-details {
        display: flex;
        align-items: center;
        gap: 20px;
        color: #666;
        font-size: 14px;
      }

      .history-date {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .history-price {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 600;
      }

      .view-all-btn {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #6c757d;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 30px 30px;
        display: block;
        width: calc(100% - 60px);
      }

      .view-all-btn:hover {
        background: #e9ecef;
        color: #495057;
      }

      .loading-plans,
      .loading-error {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading-plans p,
      .loading-error p {
        font-size: 16px;
        margin-bottom: 15px;
      }

      .loading-error p {
        color: #dc3545;
      }

      @media (max-width: 1024px) {
        .topup-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .history-card {
          position: static;
        }

        /* Premium responsive styles in topup-premium.css */

        .current-plan-stats {
          flex-direction: column;
          gap: 20px;
        }

        .section-header {
          padding: 30px 20px;
        }

        .history-timeline {
          padding: 30px 20px;
        }

        .history-details {
          flex-direction: column;
          gap: 8px;
          align-items: flex-start;
        }

        .upgrade-history-section {
          margin-top: 40px;
        }
      }

      @media (max-width: 640px) {
        .main-container {
          padding: 15px;
          margin: 20px auto;
        }

        .tabs {
          width: 100%;
        }

        .tab-btn {
          flex: 1;
          padding: 12px 20px;
        }

        .topup-container {
          padding: 0;
          margin: 0;
        }

        .topup-card,
        .history-card,
        .premium-history-card {
          padding: 20px;
        }

        .topup-card h2 {
          font-size: 20px;
        }

        .history-section h3 {
          font-size: 16px;
        }

        .amount-presets {
          grid-template-columns: repeat(2, 1fr);
        }

        .method-options {
          flex-direction: column;
        }

        .method-option {
          justify-content: flex-start;
          gap: 12px;
        }

        .method-logo {
          width: 32px;
          height: 32px;
        }

        .current-plan-section {
          padding: 25px;
        }

        .current-plan-title {
          font-size: 24px;
        }

        .current-plan-stats {
          gap: 15px;
        }

        .stat-value {
          font-size: 22px;
        }

        /* Premium responsive in topup-premium.css */
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <div class="main-container">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('topup')">
          N·∫°p Ti·ªÅn
        </button>
        <button class="tab-btn" onclick="switchTab('premium')">N√¢ng c·∫•p g√≥i</button>
      </div>

      <!-- Topup Tab Content -->
      <div id="topup-tab" class="tab-content active">
        <div class="topup-container">
          <div class="topup-wrapper">
            <div class="topup-card">
          <div class="balance-card">
                <h3>Th√¥ng Tin T√†i Kho·∫£n</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                  <div>
                    <div style="font-size: 0.9rem; color: #4a4a4a; margin-bottom: 5px;">S·ªë D∆∞ Hi·ªán T·∫°i</div>
                    <div style="display: flex; align-items: baseline">
                      <span class="balance-amount" id="balance-display">0</span>
                      <span class="balance-unit">ƒë</span>
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 0.9rem; color: #4a4a4a; margin-bottom: 5px;">T·ªïng Ti·ªÅn ƒê√£ N·∫°p</div>
                    <div style="display: flex; align-items: baseline">
                      <span class="balance-amount" id="total-deposited-display">0</span>
                      <span class="balance-unit">ƒë</span>
                    </div>
                  </div>
                </div>
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 18px; margin-top: 4px;">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                      <div style="font-size: 13px; color: #4a4a4a; margin-bottom: 8px;">G√≥i Hi·ªán T·∫°i</div>
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px; font-weight: 700; color: #1a1a1a;" id="plan-badge-display">
                          FREE
                        </span>
                        <span style="display: none;" id="current-plan-display">FREE</span>
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 13px; color: #4a4a4a; margin-bottom: 8px;">S·ªë d∆∞ kh·∫£ d·ª•ng</div>
                      <div style="font-size: 20px; font-weight: 700; letter-spacing: -0.3px; color: #1a1a1a;" id="available-balance-display">0ƒë</div>
                    </div>
                  </div>
                </div>
              </div>

              <h2>N·∫°p Ti·ªÅn</h2>
              <p>N·∫°p ti·ªÅn v√†o t√†i kho·∫£n ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng t·∫°o ·∫£nh</p>

              <div class="info-message">
                Hi·ªán t·∫°i ch√∫ng t√¥i h·ªó tr·ª£ thanh to√°n qua Momo. VNPay s·∫Ω s·ªõm ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
              </div>

              <div class="form-group">
                <label>Ch·ªçn s·ªë ti·ªÅn n·∫°p</label>
                <div class="amount-presets">
                  <button class="amount-btn" data-amount="20000">20K</button>
                  <button class="amount-btn" data-amount="50000">50K</button>
                  <button class="amount-btn" data-amount="100000">100K</button>
                  <button class="amount-btn" data-amount="200000">200K</button>
                  <button class="amount-btn" data-amount="500000">500K</button>
                  <button class="amount-btn" data-amount="1000000">1M</button>
                </div>
                <input
                  type="number"
                  id="amount-input"
                  placeholder="Ho·∫∑c nh·∫≠p s·ªë ti·ªÅn (VNƒê)"
                  min="1000"
                  step="1000"
                />
              </div>

              <div class="payment-method">
                <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                <div class="method-options">
                  <label class="method-option active">
                    <input type="radio" name="payment-method" value="momo" checked />
                    <img
                      src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-MoMo-Square-1024x1024.png"
                      alt="MoMo logo"
                      class="method-logo"
                    />
                    <span>MoMo</span>
                  </label>
                  <label class="method-option">
                    <input type="radio" name="payment-method" value="vnpay" />
                    <img
                      src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.jpg"
                      alt="VNPay logo"
                      class="method-logo"
                    />
                    <span>VNPay</span>
                  </label>
                </div>
              </div>

              <button class="topup-btn" id="topup-btn" disabled>
                N·∫°p Ti·ªÅn Ngay
              </button>
            </div>
          </div>

          <div class="history-card">
            <div class="history-section">
              <h3>L·ªãch S·ª≠ N·∫°p Ti·ªÅn</h3>
              <div class="history-list" id="history-list">
                <p style="text-align: center; color: #999">
                  Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p ti·ªÅn
                </p>
              </div>
              <button
                class="view-all-btn"
                id="view-all-btn"
                style="display: none"
              >
                Xem T·∫•t C·∫£
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Premium Tab Content -->
      <div id="premium-tab" class="tab-content">
          <div class="plans-section">
            <h2 class="section-title">
              N√¢ng c·∫•p g√≥i ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng n√¢ng cao
            </h2>
            <p class="section-subtitle">
              N√¢ng c·∫•p ƒë·ªÉ m·ªü kh√≥a c√°c t√≠nh nƒÉng cao c·∫•p v√† t·∫°o ·∫£nh kh√¥ng gi·ªõi
              h·∫°n
            </p>

            <div class="premium-grid" id="premium-grid">
              <!-- Plans will be loaded dynamically from database -->
              <div class="loading-plans">
                <p>ƒêang t·∫£i danh s√°ch g√≥i...</p>
              </div>
            </div>
          </div>

          <!-- FAQ Section -->
          <div class="faq-section">
            <h2 class="section-title">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</h2>
            <p class="section-subtitle">T√¨m c√¢u tr·∫£ l·ªùi cho c√°c th·∫Øc m·∫Øc ph·ªï bi·∫øn v·ªÅ d·ªãch v·ª• c·ªßa ch√∫ng t√¥i</p>

            <div class="faq-item">
              <div class="faq-question">
                üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n n√†o ƒë∆∞·ª£c ch·∫•p nh·∫≠n?
              </div>
              <div class="faq-answer">
                Ch√∫ng t√¥i ch·∫•p nh·∫≠n thanh to√°n qua V√≠ MoMo, th·∫ª ng√¢n h√†ng n·ªôi ƒë·ªãa, th·∫ª t√≠n d·ª•ng/ghi n·ª£ qu·ªëc t·∫ø (Visa, Mastercard) v√† c√°c v√≠ ƒëi·ªán t·ª≠ ph·ªï bi·∫øn t·∫°i Vi·ªát Nam. T·∫•t c·∫£ giao d·ªãch ƒë·ªÅu ƒë∆∞·ª£c m√£ h√≥a v√† b·∫£o m·∫≠t tuy·ªát ƒë·ªëi.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">
                üîÑ T√¥i c√≥ th·ªÉ h·ªßy g√≥i Premium b·∫•t c·ª© l√∫c n√†o kh√¥ng?
              </div>
              <div class="faq-answer">
                C√≥, b·∫°n c√≥ th·ªÉ h·ªßy g√≥i Premium b·∫•t c·ª© l√∫c n√†o m√† kh√¥ng m·∫•t ph√≠. B·∫°n v·∫´n s·∫Ω s·ª≠ d·ª•ng ƒë∆∞·ª£c ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng Premium ƒë·∫øn h·∫øt k·ª≥ thanh to√°n hi·ªán t·∫°i. Sau ƒë√≥ t√†i kho·∫£n s·∫Ω t·ª± ƒë·ªông chuy·ªÉn v·ªÅ g√≥i mi·ªÖn ph√≠.
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">
                üé® T√¥i c√≥ th·ªÉ t·∫°o bao nhi√™u ·∫£nh m·ªói ng√†y?
              </div>
              <div class="faq-answer">
                G√≥i Mi·ªÖn Ph√≠ cho ph√©p t·∫°o 15 ·∫£nh/ng√†y. G√≥i Pro n√¢ng l√™n 100 ·∫£nh/ng√†y v·ªõi ch·∫•t l∆∞·ª£ng cao h∆°n. G√≥i Max kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng ·∫£nh v√† h·ªó tr·ª£ batch processing ƒë·ªÉ t·∫°o nhi·ªÅu ·∫£nh c√πng l√∫c.
              </div>
            </div>


          </div>

          <!-- History Section -->
          <div class="upgrade-history-section">
            <div class="section-header">
              <h2 class="section-title">L·ªãch s·ª≠ n√¢ng c·∫•p</h2>
              <p class="section-subtitle">
                Theo d√µi qu√° tr√¨nh n√¢ng c·∫•p v√† thanh to√°n c·ªßa b·∫°n
              </p>
            </div>

            <div class="history-timeline" id="premium-history-list">
              <div class="empty-history">
                <div class="empty-icon">üìã</div>
                <h3>Ch∆∞a c√≥ l·ªãch s·ª≠ n√¢ng c·∫•p</h3>
                <p>
                  B·∫°n ch∆∞a th·ª±c hi·ªán n√¢ng c·∫•p n√†o. Ch·ªçn m·ªôt g√≥i Premium ƒë·ªÉ b·∫Øt
                  ƒë·∫ßu tr·∫£i nghi·ªám c√°c t√≠nh nƒÉng cao c·∫•p.
                </p>
                <button class="upgrade-now-btn" onclick="scrollToPlans()">
                  N√¢ng c·∫•p ngay
                </button>
              </div>
            </div>

            <button
              class="view-all-btn"
              id="premium-view-all-btn"
              style="display: none"
            >
              Xem t·∫•t c·∫£ l·ªãch s·ª≠
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal cho l·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß -->
    <div class="modal" id="history-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>L·ªãch S·ª≠ N·∫°p Ti·ªÅn</h2>
          <button class="close-btn" id="close-modal-btn">&times;</button>
        </div>
        <div class="modal-history-list" id="modal-history-list">
          <p style="text-align: center; color: #999">ƒêang t·∫£i...</p>
        </div>
      </div>
    </div>

    <!-- Modal cho l·ªãch s·ª≠ premium ƒë·∫ßy ƒë·ªß -->
    <div class="modal" id="premium-history-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>L·ªãch S·ª≠ Premium</h2>
          <button class="close-btn" id="premium-close-modal-btn">
            &times;
          </button>
        </div>
        <div class="modal-history-list" id="premium-modal-history-list">
          <p style="text-align: center; color: #999">ƒêang t·∫£i...</p>
        </div>
      </div>
    </div>

    <div id="footer"></div>

    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/toast-modal.js"></script>
    <script src="/assets/js/floating-chat-loader.js"></script>
    <script>
      const amountInput = document.getElementById("amount-input");
      const topupBtn = document.getElementById("topup-btn");
      const amountBtns = document.querySelectorAll(".amount-btn");
      const historyList = document.getElementById("history-list");
      let selectedAmount = null;

      // Premium variables
      let selectedPlan = null;
      let allPremiumHistory = [];

      // Check login
      function checkLogin() {
        const token = localStorage.getItem("token");
        if (!token) {
          showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc", "error");
          setTimeout(() => window.location.href = "/login.html", 1000);
          return false;
        }
        return true;
      }

      // Tab switching function
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}-tab`).classList.add("active");

        // Load data for the switched tab
        if (tabName === "premium") {
          loadPremiumData();

          // Also update immediately after tab switch to avoid delay
          setTimeout(() => {
            const mainPlanDisplay = document.getElementById("current-plan-display");
            const mainPlanText = mainPlanDisplay ? mainPlanDisplay.textContent : '';

            let planType = 'free';
            if (mainPlanText.includes('PRO')) {
              planType = 'pro';
            } else if (mainPlanText.includes('MAX')) {
              planType = 'max';
            } else if (mainPlanText.includes('BASIC')) {
              planType = 'basic';
            }

            updatePlanButtons(planType);
          }, 50); // Very small delay to ensure DOM is ready
        }
      }

      // Load premium data
      async function loadPremiumData() {
        if (!checkLogin()) return;

        await loadPlans();
        await loadCurrentPremium();
        loadPremiumHistory();
      }

      // Load plans from database
      async function loadPlans() {
        try {
          const response = await fetch("/api/premium/plans");

          if (!response.ok) {
            console.error("Plans API Error:", response.status, response.statusText);
            document.getElementById("premium-grid").innerHTML =
              '<div class="loading-error"><p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch g√≥i. Vui l√≤ng th·ª≠ l·∫°i sau.</p></div>';
            return null;
          }

          const data = await response.json();

          if (data.success && data.plans) {
            renderPlans(data.plans);
            return data.plans;
          } else if (!data.success) {
            throw new Error(data.error || "Failed to load plans");
          } else {
            throw new Error("Invalid response format");
          }
        } catch (error) {
          console.error("Error loading plans:", error);
          document.getElementById("premium-grid").innerHTML =
            '<div class="loading-error"><p>L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.</p></div>';
            return null;
        }
      }

      // Render plans from database data
      function renderPlans(plans) {
        // Store plans globally for modal usage
        window.currentPlans = plans;

        const plansGrid = document.getElementById("premium-grid");

        const planOrder = ['free', 'pro', 'max'];
        const icons = {
          free: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="6"/>
            <circle cx="12" cy="12" r="2"/>
          </svg>`,
          pro: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>`,
          max: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2l2 7h7l-5.5 4.5 2 7L12 16l-5.5 4.5 2-7L3 9h7z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>`
        };

        const badges = {
          free: '',
          pro: '<div class="popular-badge">Ph·ªï bi·∫øn nh·∫•t</div>',
          max: '<div class="popular-badge">Gi√° t·ªët nh·∫•t</div>'
        };

        let html = planOrder.map(planKey => {
          const plan = plans[planKey];
          if (!plan) return '';

          const planClass = planKey === 'free' ? 'premium-card--free' :
                           planKey === 'pro' ? 'premium-card--popular' :
                           planKey === 'max' ? 'premium-card--max' : 'premium-card--standard';

          return `
            <div class="premium-card ${planClass}" data-plan="${planKey}">
              ${badges[planKey]}
              <div class="plan-icon">${icons[planKey]}</div>
              <div class="plan-name">${plan.name}</div>
              <div class="plan-price">${plan.price > 0 ? plan.price.toLocaleString('vi-VN') + 'ƒë' : '0ƒë'}</div>
              <div class="plan-duration">${plan.duration === 0 ? 'Mi·ªÖn ph√≠' :
                plan.duration === 30 ? 'm·ªói th√°ng' :
                plan.duration === 365 ? 'm·ªói nƒÉm' :
                `${plan.duration} ng√†y`}</div>
              <ul class="plan-features">
                ${plan.features.map(feature => `<li>${feature.name}</li>`).join('')}
              </ul>
              <button class="premium-btn" data-plan="${planKey}">
                ${planKey === 'free' ? 'G√≥i mi·ªÖn ph√≠' : 'N√¢ng c·∫•p g√≥i'}
              </button>
            </div>
          `;
        }).join('');

        plansGrid.innerHTML = html;

        // Add event listeners to plan buttons
        plansGrid.querySelectorAll('.premium-btn').forEach(btn => {
          const planType = btn.dataset.plan;
          if (planType && planType !== 'free') {
            btn.addEventListener('click', () => selectPlan(planType));
          }
        });

        // Try to get current plan from multiple sources (prioritize topup tab) - IMMEDIATE UPDATE
        const updatePlanButtonsImmediately = () => {
          // Method 1: Check the main balance display (topup tab) - most reliable
          const mainPlanDisplay = document.getElementById("current-plan-display");
          const mainPlanText = mainPlanDisplay ? mainPlanDisplay.textContent : '';

          // Method 2: Check premium badge (premium tab)
          const premiumPlanBadge = document.getElementById("current-plan-badge");
          const premiumPlanText = premiumPlanBadge ? premiumPlanBadge.textContent : '';

          // Prioritize main display since it shows PRO correctly
          let planType = 'free';
          const sourceText = mainPlanText || premiumPlanText;

          if (sourceText.includes('PRO')) {
            planType = 'pro';
          } else if (sourceText.includes('MAX')) {
            planType = 'max';
          } else if (sourceText.includes('BASIC')) {
            planType = 'basic';
          }

          updatePlanButtons(planType);
        };

        // Update immediately after HTML is set
        updatePlanButtonsImmediately();

        // Also update after a small delay for any dynamic content
        setTimeout(updatePlanButtonsImmediately, 100);
      }

      // Load current premium status
      async function loadCurrentPremium() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/premium/current", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            console.error("API Error:", response.status, response.statusText);
            // Show error state with null checks
            const badgeEl = document.getElementById("current-plan-badge");
            const imagesEl = document.getElementById("images-count");
            const creditsEl = document.getElementById("credits-left");
            const resetEl = document.getElementById("next-reset");

            if (badgeEl) badgeEl.textContent = "Kh√¥ng th·ªÉ t·∫£i";
            if (imagesEl) imagesEl.textContent = "-";
            if (creditsEl) creditsEl.textContent = "-";
            if (resetEl) resetEl.textContent = "-";

            updatePlanButtons("free");
            return;
          }

          const data = await response.json();


          let planBadge = "Mi·ªÖn ph√≠";
          let imagesCount = 0;
          let creditsLeft = 15;
          let nextReset = "H√¥m nay";

          if (data.hasPremium) {
            planBadge = data.planName;
            imagesCount = data.imagesCreated || 0;
            creditsLeft = data.dailyLimit === -1 ? "‚àû" : data.dailyLimit;

            if (data.expiryDate) {
              const expiryDate = new Date(data.expiryDate);
              const today = new Date();
              const daysLeft = Math.ceil(
                (expiryDate - today) / (1000 * 60 * 60 * 24)
              );
              nextReset = daysLeft > 0 ? `${daysLeft} ng√†y` : "H·∫øt h·∫°n";
            } else {
              nextReset = data.plan === "free" ? "H√¥m nay" : "Vƒ©nh vi·ªÖn";
            }
          }

          // Update elements with null checks
          const badgeEl = document.getElementById("current-plan-badge");
          const imagesEl = document.getElementById("images-count");
          const creditsEl = document.getElementById("credits-left");
          const resetEl = document.getElementById("next-reset");

          if (badgeEl) badgeEl.textContent = planBadge;
          if (imagesEl) imagesEl.textContent = imagesCount;
          if (creditsEl) creditsEl.textContent = creditsLeft;
          if (resetEl) resetEl.textContent = nextReset;

          // Update plan buttons state with a small delay to ensure DOM is ready
          let currentPlanType = data?.plan || "free";

          // Check if API data conflicts with main display (which is more reliable)
          const mainPlanDisplay = document.getElementById("current-plan-display");
          const mainPlanText = mainPlanDisplay ? mainPlanDisplay.textContent : '';

          if (mainPlanText.includes('PRO') && currentPlanType !== 'pro') {
            currentPlanType = 'pro';
          } else if (mainPlanText.includes('MAX') && currentPlanType !== 'max') {
            currentPlanType = 'max';
          }

          // Use setTimeout to ensure DOM is fully updated before updating buttons
          setTimeout(() => {
            updatePlanButtons(currentPlanType);
          }, 200);
        } catch (error) {
          console.error("Error loading current premium:", error);
          // Show error state with null checks
          const badgeEl = document.getElementById("current-plan-badge");
          const imagesEl = document.getElementById("images-count");
          const creditsEl = document.getElementById("credits-left");
          const resetEl = document.getElementById("next-reset");

          if (badgeEl) badgeEl.textContent = "L·ªói t·∫£i";
          if (imagesEl) imagesEl.textContent = "-";
          if (creditsEl) creditsEl.textContent = "-";
          if (resetEl) resetEl.textContent = "-";

          updatePlanButtons("free");
        }
      }

      // Update plan buttons state
      function updatePlanButtons(currentPlan) {
        const planCards = document.querySelectorAll(".premium-card");

        if (planCards.length === 0) {
          return;
        }

        // Try multiple approaches to find the current plan card
        planCards.forEach((card) => {
          const planType = card.dataset.plan;
          const button = card.querySelector(".premium-btn");

          if (!button) {
            return;
          }

          // Multiple matching strategies
          const isCurrentPlan = (
            planType === currentPlan ||
            (currentPlan === 'pro' && card.textContent.includes('PRO')) ||
            (currentPlan === 'max' && card.textContent.includes('MAX')) ||
            (currentPlan === 'free' && card.textContent.includes('FREE'))
          );

          if (isCurrentPlan) {
            button.textContent = "ƒêang s·ª≠ d·ª•ng";
            button.classList.add("current-plan");
            button.disabled = true;
            button.style.background = "#666";
            button.style.color = "white";
          } else {
            button.textContent = planType === 'free' ? 'G√≥i mi·ªÖn ph√≠' : 'N√¢ng c·∫•p g√≥i';
            button.classList.remove("current-plan");
            button.disabled = false;
            button.style.background = "";
            button.style.color = "";

            // Re-add event listener for non-current plans
            if (planType !== 'free') {
              const newButton = button.cloneNode(true);
              newButton.addEventListener('click', () => selectPlan(planType));
              button.replaceWith(newButton);
            }
          }
        });
      }

      // Global variables for upgrade modal
      let currentUpgradePlan = null;
      let selectedPaymentMethod = null;

      // Select plan function - Navigate to upgrade page
      function selectPlan(planType) {
        if (!checkLogin()) return;

        // Navigate to dedicated upgrade page
        window.location.href = `/upgrade.html#upgrade-${planType}`;
      }

      // Check if we're on upgrade flow
      function checkUpgradeFlow() {
        const urlParams = new URLSearchParams(window.location.search);
        const upgradePlan = urlParams.get('upgrade');

        if (upgradePlan) {
          // Switch to premium tab
          switchTab('premium');

          // Scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });

          // Wait a bit for plans to load, then show modal
          setTimeout(() => {
            const plans = window.currentPlans || {};
            const plan = plans[upgradePlan];

            if (plan) {
              currentUpgradePlan = upgradePlan;

              // Populate modal with plan details
              document.getElementById('modal-plan-name').textContent = plan.name;
              document.getElementById('modal-plan-duration').textContent = plan.duration > 0 ? `${plan.duration} ng√†y` : 'Vƒ©nh vi·ªÖn';
              document.getElementById('modal-plan-price').textContent = plan.price > 0 ? `${plan.price.toLocaleString('vi-VN')}ƒë` : 'Mi·ªÖn ph√≠';

              // Show key features
              const keyFeatures = plan.features && plan.features.length > 0
                ? plan.features.filter(f => f.enabled).slice(0, 3).map(f => f.name).join(', ')
                : 'Kh√¥ng gi·ªõi h·∫°n t√≠nh nƒÉng';
              document.getElementById('modal-plan-features').textContent = keyFeatures;

              // Show modal
              document.getElementById('premium-upgrade-modal').style.display = 'flex';

              // Update URL to clean version
              window.history.replaceState({}, '', `/topup.html#upgrade-${upgradePlan}`);
            }
          }, 500);
        }
      }

      // Call on page load
      window.addEventListener('DOMContentLoaded', () => {
        checkUpgradeFlow();
      });

      // Modal functions
      function closeUpgradeModal() {
        document.getElementById('premium-upgrade-modal').style.display = 'none';
        currentUpgradePlan = null;
        selectedPaymentMethod = null;
        // Reset form
        document.querySelectorAll('input[name="payment"]').forEach(input => input.checked = false);
        document.querySelectorAll('.code-input').forEach(input => input.value = '');
        const continueBtn = document.getElementById('continue-btn');
        if (continueBtn) {
          continueBtn.disabled = true;
        }
        // Reset to step 1
        goToStep(1);

        // Clean URL
        if (window.location.hash.includes('upgrade-')) {
          window.history.replaceState({}, '', '/topup.html');
        }
      }

      function goToStep(stepNumber) {
        document.querySelectorAll('.upgrade-step').forEach(step => {
          step.style.display = 'none';
        });
        document.getElementById(`upgrade-step-${stepNumber}`).style.display = 'block';

        if (stepNumber === 2) {
          // Setup code inputs
          setupCodeInputs();
          // Get user email
          const userEmail = getCurrentUserEmail();
          document.getElementById('verification-email').textContent = userEmail;
        }
      }

      function selectPaymentMethod(method) {
        selectedPaymentMethod = method;

        // Update radio buttons
        document.querySelectorAll('input[name="payment"]').forEach(input => {
          input.checked = input.value === method;
        });

        // Enable continue button
        const continueBtn = document.getElementById('continue-btn');
        if (continueBtn) {
          continueBtn.disabled = false;
        }
      }

      async function sendVerificationCode() {
        if (!selectedPaymentMethod) {
          showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!', 'warning');
          return;
        }

        try {
          const continueBtn = document.getElementById('continue-btn');
          continueBtn.textContent = 'ƒêang g·ª≠i m√£...';
          continueBtn.disabled = true;

          const token = localStorage.getItem('token');
          const response = await fetch('/api/premium/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ plan: currentUpgradePlan })
          });

          const result = await response.json();

          if (result.success) {
            goToStep(2);
            startResendTimer();
          } else {
            showToast('Kh√¥ng th·ªÉ g·ª≠i m√£: ' + result.error, 'error');
            continueBtn.textContent = 'Ti·∫øp t·ª•c';
            continueBtn.disabled = false;
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('L·ªói khi g·ª≠i m√£ x√°c minh!', 'error');
          const continueBtn = document.getElementById('continue-btn');
          continueBtn.textContent = 'Ti·∫øp t·ª•c';
          continueBtn.disabled = false;
        }
      }

      function setupCodeInputs() {
        const codeInputs = document.querySelectorAll('.code-input');
        codeInputs.forEach((input, index) => {
          input.value = '';
          input.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && index < codeInputs.length - 1) {
              codeInputs[index + 1].focus();
            }
          });
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
              codeInputs[index - 1].focus();
            }
          });
          input.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
          });
        });
        codeInputs[0].focus();
      }

      let resendTimer = null;
      function startResendTimer() {
        let seconds = 60;
        const resendTimerEl = document.getElementById('resend-timer');
        const resendBtnEl = document.getElementById('resend-code-btn');

        resendTimerEl.style.display = 'inline';
        resendBtnEl.style.display = 'none';

        if (resendTimer) clearInterval(resendTimer);

        resendTimer = setInterval(() => {
          seconds--;
          resendTimerEl.textContent = `G·ª≠i l·∫°i m√£ sau ${seconds}s`;
          if (seconds <= 0) {
            clearInterval(resendTimer);
            resendTimerEl.style.display = 'none';
            resendBtnEl.style.display = 'inline';
          }
        }, 1000);
      }

      async function resendVerificationCode() {
        startResendTimer();
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/premium/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ plan: currentUpgradePlan })
          });
          const result = await response.json();
          if (result.success) {
            showToast('M√£ m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i!', 'success');
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }

      function getVerificationCode() {
        const codeInputs = document.querySelectorAll('.code-input');
        let code = '';
        codeInputs.forEach(input => code += input.value);
        return code;
      }

      async function verifyAndProceed() {
        const code = getVerificationCode();
        if (code.length !== 6) {
          showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 6 s·ªë!', 'warning');
          return;
        }

        try {
          const token = localStorage.getItem('token');
          const response = await fetch('/api/premium/verify-and-upgrade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              plan: currentUpgradePlan,
              code: code,
              paymentMethod: selectedPaymentMethod
            })
          });

          const result = await response.json();

          if (result.success) {
            if (selectedPaymentMethod === 'momo') {
              await createMomoPayment(currentUpgradePlan);
            } else if (selectedPaymentMethod === 'vnpay') {
              showToast('üîí VNPay ƒëang ph√°t tri·ªÉn!', 'info');
              closeUpgradeModal();
            }
          } else {
            showToast('‚ùå ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('‚ùå X√°c minh th·∫•t b·∫°i!', 'error');
        }
      }

      function getCurrentUserEmail() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user.email) return user.email;
          } catch (e) {}
        }
        const token = localStorage.getItem('token');
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.email;
          } catch (e) {}
        }
        return 'email c·ªßa b·∫°n';
      }

      // Create MoMo payment directly
      async function createMomoPayment(planType) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'error');
            return;
          }

          const response = await fetch("/api/premium/purchase", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ plan: planType }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("API Error:", response.status, errorText);
            showToast("L·ªói m√°y ch·ªß: " + (response.statusText || "Vui l√≤ng th·ª≠ l·∫°i sau"), 'error');
            return;
          }

          const result = await response.json();

          if (result.success && result.payUrl) {
            // Close modal and redirect to MoMo
            closeUpgradeModal();
            window.open(result.payUrl, '_blank');
          } else {
            showToast('Kh√¥ng th·ªÉ t·∫°o thanh to√°n MoMo: ' + (result.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          console.error('Error creating MoMo payment:', error);
          showToast('L·ªói khi t·∫°o thanh to√°n MoMo. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        }
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('premium-upgrade-modal');
        if (event.target === modal) {
          closeUpgradeModal();
        }
      }

      // Process upgrade
      async function processUpgrade(planType) {
        try {
          const token = localStorage.getItem("token");

          if (!token) {
            showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi n√¢ng c·∫•p!", 'error');
            return;
          }

          const response = await fetch("/api/premium/purchase", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ plan: planType }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("API Error:", response.status, errorText);
            showToast(
              "L·ªói m√°y ch·ªß: " + (response.statusText || "Vui l√≤ng th·ª≠ l·∫°i sau"),
              'error'
            );
            return;
          }

          const result = await response.json();

          if (result.success) {
            if (result.payUrl) {
              // Redirect to payment
              window.location.href = result.payUrl;
            } else {
              showToast(
                "N√¢ng c·∫•p th√†nh c√¥ng! Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.",
                'success'
              );
              loadCurrentPremium();
              loadPremiumHistory(); // Refresh history
            }
          } else {
            showToast(
              "L·ªói: " +
                (result.error ||
                  result.message ||
                  "Kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu. Vui l√≤ng li√™n h·ªá h·ªó tr·ª£."),
              'error'
            );
          }
        } catch (error) {
          console.error("‚ùå L·ªói:", error);
          showToast(
            "L·ªói k·∫øt n·ªëi: " +
              error.message +
              ". Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.",
            'error'
          );
        }
      }

      // Load premium history
      async function loadPremiumHistory() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/premium/history", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            console.error(
              "Premium History API Error:",
              response.status,
              response.statusText
            );
            document.getElementById("premium-history-list").innerHTML =
              '<div class="empty-history"><div class="empty-icon">‚ö†Ô∏è</div><h3>L·ªói t·∫£i l·ªãch s·ª≠</h3><p>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ n√¢ng c·∫•p. Vui l√≤ng th·ª≠ l·∫°i sau.</p></div>';
            document.getElementById("premium-view-all-btn").style.display =
              "none";
            return;
          }

          allPremiumHistory = await response.json();

          const premiumHistoryList = document.getElementById(
            "premium-history-list"
          );

          // Show history with the new timeline design (empty state is handled in renderPremiumHistoryItems)
          premiumHistoryList.innerHTML = renderPremiumHistoryItems(
            allPremiumHistory,
            6
          );

          // Show "View All" button if more than 10 items
          const viewAllBtn = document.getElementById("premium-view-all-btn");
          if (allPremiumHistory.length > 10) {
            viewAllBtn.style.display = "block";
          } else {
            viewAllBtn.style.display = "none";
          }
        } catch (error) {
          console.error("Error loading premium history:", error);
          document.getElementById("premium-history-list").innerHTML =
            '<div class="empty-history"><div class="empty-icon">‚ö†Ô∏è</div><h3>L·ªói k·∫øt n·ªëi</h3><p>Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.</p></div>';
          document.getElementById("premium-view-all-btn").style.display =
            "none";
        }
      }

      // Scroll to plans section
      function scrollToPlans() {
        const plansSection = document.querySelector(".plans-section");
        if (plansSection) {
          plansSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      // Render premium history items with new timeline design
      function renderPremiumHistoryItems(items, limit = null) {
        const itemsToShow = limit ? items.slice(0, limit) : items;

        if (itemsToShow.length === 0) {
          return `
          <div class="empty-history">
            <div class="empty-icon">üìã</div>
            <h3>Ch∆∞a c√≥ l·ªãch s·ª≠ n√¢ng c·∫•p</h3>
            <p>B·∫°n ch∆∞a th·ª±c hi·ªán n√¢ng c·∫•p n√†o. Ch·ªçn m·ªôt g√≥i Premium ƒë·ªÉ b·∫Øt ƒë·∫ßu tr·∫£i nghi·ªám c√°c t√≠nh nƒÉng cao c·∫•p.</p>
            <button class="upgrade-now-btn" onclick="scrollToPlans()">N√¢ng c·∫•p ngay</button>
          </div>
        `;
        }

        return itemsToShow
          .map((item) => {
            const date = new Date(item.createdAt);
            const formattedDate = date.toLocaleDateString("vi-VN", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            const statusClass =
              item.status === "active" || item.status === "success" || item.status === "completed" ? "success" :
              item.status === "pending" ? "pending" :
              item.status === "failed" || item.status === "cancelled" ? "failed" : "pending";

            const statusText =
              item.status === "active" || item.status === "success" || item.status === "completed"
                ? "Th√†nh c√¥ng"
                : item.status === "pending"
                ? "ƒêang x·ª≠ l√Ω"
                : item.status === "failed"
                ? "Th·∫•t b·∫°i"
                : item.status === "cancelled"
                ? "ƒê√£ h·ªßy"
                : "Ch∆∞a thanh to√°n";

            const statusIcon =
              item.status === "active" || item.status === "success" || item.status === "completed"
                ? "‚úì"
                : item.status === "pending"
                ? "‚è≥"
                : item.status === "failed"
                ? "‚úó"
                : item.status === "cancelled"
                ? "‚úó"
                : "‚è≥";

            const priceDisplay =
              item.price > 0
                ? `${item.price.toLocaleString("vi-VN")}ƒë`
                : "Mi·ªÖn ph√≠";

            return `
            <div class="history-item-timeline">
              <div class="history-icon ${statusClass}">${statusIcon}</div>
              <div class="history-content">
                <div class="history-header">
                  <div class="history-plan-name">${
                    item.planName || "G√≥i Premium"
                  }</div>
                  <span class="history-status ${statusClass}">${statusText}</span>
                </div>
                <div class="history-details">
                  <div class="history-date">
                    üìÖ ${formattedDate}
                  </div>
                  <div class="history-price">
                    üí∞ ${priceDisplay}
                  </div>
                  ${
                    item.paymentMethod
                      ? `
                    <div class="history-payment">
                    üí≥ ${
                      item.paymentMethod === "momo"
                        ? "V√≠ Momo"
                        : item.paymentMethod
                    }
                    </div>
                  `
                      : ""
                  }
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      amountBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          amountBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedAmount = parseInt(btn.dataset.amount);
          amountInput.value = selectedAmount;
          updateTopupBtn();
        });
      });

      amountInput.addEventListener("input", () => {
        amountBtns.forEach((b) => b.classList.remove("active"));
        selectedAmount = parseInt(amountInput.value) || null;
        updateTopupBtn();
      });

      function updateTopupBtn() {
        topupBtn.disabled = !selectedAmount || selectedAmount < 1000;
      }

      // Topup button
      topupBtn.addEventListener("click", async () => {
        if (!checkLogin()) return;

        const token = localStorage.getItem("token");
        const amount = selectedAmount || parseInt(amountInput.value);
        const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;

        if (!amount || amount < 1000) {
          showToast("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá (t·ªëi thi·ªÉu 1000ƒë)", 'warning');
          return;
        }

        // For now, only process MoMo payments
        if (selectedMethod === "vnpay") {
          showToast("Thanh to√°n qua VNPay ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng ch·ªçn MoMo ƒë·ªÉ thanh to√°n.", 'info');
          return;
        }

        try {
          topupBtn.disabled = true;
          topupBtn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";

          // Get the current page URL to return to after payment
          const returnTo = window.location.pathname + window.location.search;
          console.log("üîó Sending returnTo:", returnTo);
          console.log("üí≥ Payment method:", selectedMethod);

          const response = await fetch("/api/topup/create-momo", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              amount,
              returnTo
            }),
          });

          console.log("üì° Response status:", response.status);
          console.log("üì° Response headers:", response.headers);

          const text = await response.text();
          console.log("üì° Response body:", text);

          const result = JSON.parse(text);
          console.log("üì° Parsed result:", result);

          if (result.success && result.payUrl) {
            // Redirect to Momo payment
            window.location.href = result.payUrl;
          } else {
            showToast(
              "L·ªói: " +
                (result.error ||
                  result.message ||
                  "Kh√¥ng th·ªÉ t·∫°o link thanh to√°n"),
              'error'
            );
          }
        } catch (error) {
          console.error("‚ùå L·ªói:", error);
          showToast("L·ªói khi t·∫°o link thanh to√°n: " + error.message, 'error');
        } finally {
          topupBtn.disabled = false;
          topupBtn.textContent = "N·∫°p Ti·ªÅn Ngay";
        }
      });

      function renderHistoryItems(items, limit = null) {
        const itemsToShow = limit ? items.slice(0, limit) : items;
        return itemsToShow
          .map((item) => {
            const date = new Date(item.createdAt).toLocaleDateString("vi-VN");
            const statusClass =
              item.status === "success" || item.status === "completed" ? "status-success" :
              item.status === "pending" ? "status-pending" :
              item.status === "failed" ? "status-failed" :
              item.status === "cancelled" ? "status-cancelled" : "status-pending";

            const statusText =
              item.status === "success" || item.status === "completed"
                ? "Th√†nh c√¥ng"
                : item.status === "pending"
                ? "ƒêang x·ª≠ l√Ω"
                : item.status === "failed"
                ? "Th·∫•t b·∫°i"
                : item.status === "cancelled"
                ? "ƒê√£ h·ªßy"
                : "Ch∆∞a thanh to√°n";

            return `
              <div class="history-item">
                <div class="history-info">
                  <div class="history-amount">+${item.amount.toLocaleString()}ƒë</div>
                  <div class="history-time">${date}</div>
                </div>
                <span class="history-status ${statusClass}">${statusText}</span>
              </div>
            `;
          })
          .join("");
      }

  // Load user's current balance and account summary
      async function loadBalance() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/topup/account-summary", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            resetAccountDisplay();
            return;
          }

          const data = await response.json();
          const balance = data.balance || 0;
          const totalDeposited = data.totalDeposited || 0;
          const totalDepositsCount = data.totalDepositsCount || 0;
          const todayDepositsAmount = data.todayDepositsAmount || 0;
          const todayDepositsCount = data.todayDepositsCount || 0;
          const currentPlan = data.currentPlan || "FREE";
          const planBadge = data.planBadge || "BASIC";
          const accountAge = data.accountAge || 0;
          const recentTopups = data.recentTopups || [];

          // Update balance display
          document.getElementById("balance-display").textContent =
            balance.toLocaleString("vi-VN");

          // Update total deposited display
          document.getElementById("total-deposited-display").textContent =
            totalDeposited.toLocaleString("vi-VN");

          // Update current plan display
          document.getElementById("current-plan-display").textContent = currentPlan;
          document.getElementById("plan-badge-display").textContent = planBadge;

          // Update available balance display (same as current balance)
          document.getElementById("available-balance-display").textContent =
            balance.toLocaleString("vi-VN") + "ƒë";

          // Update plan badge colors based on plan type
          updatePlanBadgeStyle(currentPlan);

        } catch (error) {
          resetAccountDisplay();
        }
      }

      // Helper function to reset account display
      function resetAccountDisplay() {
        document.getElementById("balance-display").textContent = "0";
        document.getElementById("total-deposited-display").textContent = "0";
        document.getElementById("current-plan-display").textContent = "FREE";
        document.getElementById("plan-badge-display").textContent = "BASIC";
        document.getElementById("available-balance-display").textContent = "0ƒë";
        updatePlanBadgeStyle("FREE");
      }

      // Helper function to update plan badge styling - removed colors, keep text only
      function updatePlanBadgeStyle(currentPlan) {
        // Do nothing - just keep the text black as defined in HTML
      }

      // Load topup history (10 items only)
      let allHistory = [];
      async function loadHistory() {
        if (!checkLogin()) return;

        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/topup/history", {
            headers: { Authorization: `Bearer ${token}` },
          });

          allHistory = await response.json();

          if (allHistory.length === 0) {
            historyList.innerHTML =
              '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p ti·ªÅn</p>';
            document.getElementById("view-all-btn").style.display = "none";
            return;
          }

          // Show only 10 items
          historyList.innerHTML = renderHistoryItems(allHistory, 6);

          // Show "View All" button if more than 10 items
          const viewAllBtn = document.getElementById("view-all-btn");
          if (allHistory.length > 10) {
            viewAllBtn.style.display = "block";
          } else {
            viewAllBtn.style.display = "none";
          }
        } catch (error) {
          console.error("L·ªói load history:", error);
          historyList.innerHTML =
            '<p style="text-align: center; color: #f00;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ n·∫°p ti·ªÅn</p>';
        }
      }

      // Load all history in modal
      function showAllHistory() {
        const modal = document.getElementById("history-modal");
        const modalHistoryList = document.getElementById("modal-history-list");

        if (allHistory.length === 0) {
          modalHistoryList.innerHTML =
            '<p style="text-align: center; color: #999;">Kh√¥ng c√≥ l·ªãch s·ª≠ n·∫°p ti·ªÅn</p>';
        } else {
          modalHistoryList.innerHTML = renderHistoryItems(allHistory);
        }

        modal.classList.add("active");
      }

      // Close modal
      function closeModal() {
        document.getElementById("history-modal").classList.remove("active");
      }

      // Auto-refresh history every 3 seconds while page is visible
      let refreshInterval = null;

      function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          loadBalance();
          loadHistory();
        }, 3000); // Refresh every 3 seconds
      }

      function stopAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
      }

      // Check if returning from MoMo payment
      async function checkPaymentReturn() {
        const params = new URLSearchParams(window.location.search);
        const paymentStatus = params.get('payment');
        const topupId = params.get('id');

        if (paymentStatus === 'success' && topupId) {
          console.log('üîç Returning from MoMo payment, checking status for:', topupId);
          
          // Show loading toast
          showToast('‚è≥ ƒêang ki·ªÉm tra k·∫øt qu·∫£ thanh to√°n...', 'info');

          // Wait a bit for callback to process
          await new Promise(resolve => setTimeout(resolve, 2000));

          try {
            // Check payment status
            const response = await fetch(`/api/topup/check-momo-status/${topupId}`);
            const data = await response.json();

            console.log('‚úÖ Payment status:', data);

            if (data.status === 'success') {
              showToast('‚úÖ N·∫°p ti·ªÅn th√†nh c√¥ng! S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
              
              // Reload balance and history
              await loadBalance();
              await loadHistory();
            } else if (data.status === 'failed') {
              showToast('‚ùå Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } else {
              // Still pending, show message
              showToast('‚è≥ Giao d·ªãch ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. Vui l√≤ng ƒë·ª£i...', 'info');
              
              // Keep checking every 3 seconds
              let checkCount = 0;
              const checkInterval = setInterval(async () => {
                checkCount++;
                if (checkCount > 10) {
                  clearInterval(checkInterval);
                  showToast('‚ö†Ô∏è Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n. Vui l√≤ng ki·ªÉm tra l·∫°i sau.', 'warning');
                  return;
                }

                const statusResponse = await fetch(`/api/topup/check-momo-status/${topupId}`);
                const statusData = await statusResponse.json();

                if (statusData.status === 'success') {
                  clearInterval(checkInterval);
                  showToast('‚úÖ N·∫°p ti·ªÅn th√†nh c√¥ng! S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
                  await loadBalance();
                  await loadHistory();
                } else if (statusData.status === 'failed') {
                  clearInterval(checkInterval);
                  showToast('‚ùå Thanh to√°n th·∫•t b·∫°i.', 'error');
                }
              }, 3000);
            }
          } catch (error) {
            console.error('‚ùå Error checking payment:', error);
            showToast('‚ùå L·ªói ki·ªÉm tra thanh to√°n: ' + error.message, 'error');
          }

          // Clean URL
          window.history.replaceState({}, '', '/topup.html');
        }
      }

      // Load on page load
      document.addEventListener("DOMContentLoaded", () => {
        // Check payment return first
        checkPaymentReturn();
        
        loadBalance();
        loadHistory();

        // Also load premium data on page load
        loadPremiumData();

        // Handle payment method selection
        const methodOptions = document.querySelectorAll('input[name="payment-method"]');
        methodOptions.forEach((radio) => {
          radio.addEventListener("change", () => {
            // Remove active class from all labels
            document.querySelectorAll(".method-option").forEach((label) => {
              label.classList.remove("active");
            });
            // Add active class to selected label
            radio.parentElement.classList.add("active");
          });
        });

        // Start auto-refresh when page gets focus (user comes back from payment)
        window.addEventListener("focus", startAutoRefresh);
        window.addEventListener("blur", stopAutoRefresh);

        // Also start auto-refresh on page load (in case user just returned)
        startAutoRefresh();

        
        // View All button
        document
          .getElementById("view-all-btn")
          .addEventListener("click", showAllHistory);

        // Close modal button
        document
          .getElementById("close-modal-btn")
          .addEventListener("click", closeModal);

        // Close modal when clicking outside
        document
          .getElementById("history-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "history-modal") {
              closeModal();
            }
          });
      });

      // Stop refresh when page unloads
      window.addEventListener("beforeunload", stopAutoRefresh);

      // Initialize premium tab when loaded
      document.addEventListener("DOMContentLoaded", () => {
        // Premium history modal
        document
          .getElementById("premium-view-all-btn")
          .addEventListener("click", showAllPremiumHistory);
        document
          .getElementById("premium-close-modal-btn")
          .addEventListener("click", closePremiumModal);

        // Close premium modal when clicking outside
        document
          .getElementById("premium-history-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "premium-history-modal") {
              closePremiumModal();
            }
          });

        // Load premium data when tab becomes active
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (
              mutation.target.id === "premium-tab" &&
              mutation.target.classList.contains("active")
            ) {
              loadPremiumData();
            }
          });
        });

        observer.observe(document.getElementById("premium-tab"), {
          attributes: true,
          attributeFilter: ["class"],
        });
      });

      // Show all premium history in modal
      function showAllPremiumHistory() {
        const modal = document.getElementById("premium-history-modal");
        const modalHistoryList = document.getElementById(
          "premium-modal-history-list"
        );

        if (allPremiumHistory.length === 0) {
          modalHistoryList.innerHTML =
            '<p style="text-align: center; color: #999;">Kh√¥ng c√≥ l·ªãch s·ª≠ mua Premium</p>';
        } else {
          modalHistoryList.innerHTML =
            renderPremiumHistoryItems(allPremiumHistory);
        }

        modal.classList.add("active");
      }

      // Close premium modal
      function closePremiumModal() {
        document
          .getElementById("premium-history-modal")
          .classList.remove("active");
      }

      // Cancel transaction function
      async function cancelTransaction(transactionId) {
        showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy giao d·ªãch n√†y?', async () => {

        try {
          const token = localStorage.getItem('token');
          if (!token) {
            showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'error');
            return;
          }

          const response = await fetch(`/api/topup/cancel/${transactionId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showToast('ƒê√£ h·ªßy giao d·ªãch th√†nh c√¥ng!', 'success');
            // Reload history to update the display
            loadHistory();
          } else {
            showToast('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ h·ªßy giao d·ªãch'), 'error');
          }
        } catch (error) {
          console.error('Error cancelling transaction:', error);
          showToast('L·ªói khi h·ªßy giao d·ªãch. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        }
        }, { danger: true });
      }
    </script>

    <!-- Premium Upgrade Modal -->
    <div id="premium-upgrade-modal" class="modal upgrade-modal" style="display: none;">
      <div class="modal-content upgrade-modal-content">
        <div class="modal-header">
          <h3>N√¢ng C·∫•p G√≥i Premium</h3>
          <span class="close-btn" onclick="closeUpgradeModal()">&times;</span>
        </div>

        <!-- Step 1: Order Details -->
        <div id="upgrade-step-1" class="upgrade-step">
          <div class="order-details">
            <div class="order-item">
              <span class="order-label">G√≥i:</span>
              <span id="modal-plan-name" class="order-value"></span>
            </div>
            <div class="order-item">
              <span class="order-label">Th·ªùi h·∫°n:</span>
              <span id="modal-plan-duration" class="order-value"></span>
            </div>
            <div class="order-item">
              <span class="order-label">Gi√°:</span>
              <span id="modal-plan-price" class="order-value price-highlight"></span>
            </div>
            <div class="order-item">
              <span class="order-label">∆Øu ƒë√£i:</span>
              <span id="modal-plan-features" class="order-value"></span>
            </div>
          </div>

          <h4 class="section-title">Ph∆∞∆°ng th·ª©c thanh to√°n</h4>
          <div class="payment-methods">
            <div class="payment-option" onclick="selectPaymentMethod('momo')">
              <input type="radio" name="payment" value="momo" id="momo-payment">
              <label for="momo-payment">
                <img
                  src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-MoMo-Square-1024x1024.png"
                  alt="MoMo logo"
                  class="method-logo"
                />
                <span>Thanh to√°n qua v√≠ MoMo</span>
              </label>
            </div>
            <div class="payment-option" onclick="selectPaymentMethod('vnpay')">
              <input type="radio" name="payment" value="vnpay" id="vnpay-payment">
              <label for="vnpay-payment">
                <img
                  src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.jpg"
                  alt="VNPay logo"
                  class="method-logo"
                />
                <span>Thanh to√°n qua v√≠ VNPAY</span>
              </label>
            </div>
          </div>

          <div class="saved-info-section">
            <label class="checkbox-label">
              <input type="checkbox" id="use-saved-info" checked>
              <span class="checkmark"></span>
              S·ª≠ d·ª•ng th√¥ng tin ƒë√£ l∆∞u
            </label>
          </div>

          <div class="step-actions">
            <button class="btn-primary btn-full" onclick="sendVerificationCode()" id="continue-btn" disabled>
              Ti·∫øp t·ª•c
            </button>
          </div>
        </div>

        <!-- Step 2: Verification Code -->
        <div id="upgrade-step-2" class="upgrade-step" style="display: none;">
          <div class="verification-section">
            <p>Nh·∫≠p m√£ x√°c minh ƒë∆∞·ª£c g·ª≠i ƒë·∫øn <strong id="verification-email"></strong></p>
            <div class="code-inputs">
              <input type="text" maxlength="1" class="code-input" data-index="0">
              <input type="text" maxlength="1" class="code-input" data-index="1">
              <input type="text" maxlength="1" class="code-input" data-index="2">
              <input type="text" maxlength="1" class="code-input" data-index="3">
              <input type="text" maxlength="1" class="code-input" data-index="4">
              <input type="text" maxlength="1" class="code-input" data-index="5">
            </div>
            <div class="resend-section">
              <span id="resend-timer">G·ª≠i l·∫°i m√£ sau 60s</span>
              <button id="resend-code-btn" class="btn-link" onclick="resendVerificationCode()" style="display: none;">G·ª≠i l·∫°i m√£</button>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn-secondary" onclick="goToStep(1)">Quay l·∫°i</button>
            <button class="btn-primary" onclick="verifyAndProceed()">X√°c nh·∫≠n</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Styles -->
    <style>
      /* Upgrade Modal Specific Styles */
      .upgrade-modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .upgrade-modal-content {
        background: white;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 520px;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }

      @keyframes slideIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      .upgrade-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 28px;
        border-bottom: 1px solid #e5e5e5;
        background: #2d2d2d;
        color: white;
        border-radius: 16px 16px 0 0;
      }

      .upgrade-modal .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      .upgrade-modal .close-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        opacity: 0.7;
        transition: all 0.2s;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
      }

      .upgrade-modal .close-btn:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
      }

      .upgrade-step {
        padding: 28px;
      }

      .order-summary-section {
        margin-bottom: 24px;
      }

      .order-details {
        background: #fafafa;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
      }

      .section-title {
        font-size: 15px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 12px;
        letter-spacing: -0.2px;
      }

      .payment-section {
        margin-bottom: 20px;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e5e5e5;
      }

      .order-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .order-item:first-child {
        padding-top: 0;
      }

      .order-label {
        font-weight: 500;
        color: #6b6b6b;
        font-size: 14px;
      }

      .order-value {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 15px;
        text-align: right;
      }

      .price-highlight {
        color: #dc2626;
        font-size: 20px;
        font-weight: 700;
      }

      .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .payment-option {
        position: relative;
      }

      .payment-option input[type="radio"] {
        display: none;
      }

      .payment-option label {
        display: flex;
        align-items: center;
        padding: 16px 18px;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        gap: 12px;
      }

      .payment-option:hover label {
        border-color: #2d2d2d;
        background: #fafafa;
      }

      .payment-option input[type="radio"]:checked + label {
        border-color: #2d2d2d;
        background: #fafafa;
        box-shadow: 0 0 0 1px #2d2d2d;
      }

      .payment-option label span {
        font-weight: 500;
        color: #1a1a1a;
        font-size: 15px;
      }

      .method-logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 8px;
      }

      .saved-info-section {
        margin-bottom: 24px;
        padding: 16px;
        background: #fafafa;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        color: #1a1a1a;
        font-weight: 500;
      }

      .checkbox-label input[type="checkbox"] {
        display: none;
      }

      .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid #d4d4d4;
        border-radius: 6px;
        margin-right: 10px;
        position: relative;
        transition: all 0.2s;
        background: white;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark {
        background: #2d2d2d;
        border-color: #2d2d2d;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
        content: '‚úì';
        position: absolute;
        color: white;
        font-size: 13px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }



      .verification-section {
        text-align: center;
        margin-bottom: 24px;
      }

      .verification-section p {
        margin-bottom: 24px;
        color: #6b6b6b;
        font-size: 15px;
        line-height: 1.6;
      }

      .verification-section strong {
        color: #1a1a1a;
      }

      .code-inputs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .code-input {
        width: 50px;
        height: 56px;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        border: 2px solid #d4d4d4;
        border-radius: 12px;
        transition: all 0.2s;
        background: white;
        color: #1a1a1a;
      }

      .code-input:focus {
        border-color: #2d2d2d;
        outline: none;
        box-shadow: 0 0 0 3px rgba(45, 45, 45, 0.1);
      }

      .resend-section {
        color: #6b6b6b;
        font-size: 14px;
      }

      .btn-link {
        background: none;
        border: none;
        color: #2d2d2d;
        cursor: pointer;
        text-decoration: underline;
        font-size: 14px;
        font-weight: 500;
        padding: 0;
      }

      .btn-link:hover {
        color: #1a1a1a;
      }

      .step-actions {
        margin-top: 24px;
        display: flex;
        gap: 12px;
      }

      .btn-primary, .btn-secondary {
        padding: 16px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        flex: 1;
      }

      .btn-primary {
        background: #2d2d2d;
        color: white;
      }

      .btn-full {
        width: 100%;
      }

      .btn-primary:hover:not(:disabled) {
        background: #1a1a1a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: white;
        color: #2d2d2d;
        border: 2px solid #e5e5e5;
      }

      .btn-secondary:hover {
        background: #fafafa;
        border-color: #2d2d2d;
      }
    </style>

  </body>
</html>

